# MoE å†…å­˜æ³„æ¼ä¿®å¤æ€»ç»“

## ğŸ” é—®é¢˜è¯Šæ–­

### åŸå§‹é—®é¢˜
å½“è®¾ç½® `use_moe=true` æ—¶ï¼Œè®­ç»ƒè¿‡ç¨‹ä¸­å†…å­˜ä½¿ç”¨é‡æŒç»­å¢é•¿ï¼Œæœ€ç»ˆå¯¼è‡´ç³»ç»Ÿå†…å­˜è€—å°½ã€‚

### æ ¹æœ¬åŸå› åˆ†æ
1. **`gate_history` æ— é™ç´¯ç§¯**ï¼š
   - `MoEBlock.gate_history` åˆ—è¡¨åœ¨æ¯æ¬¡å‰å‘ä¼ æ’­æ—¶éƒ½ä¼šæ·»åŠ æ–°çš„å¼ é‡
   - è®­ç»ƒè¿‡ç¨‹ä¸­ä»æœªæ¸…ç†ï¼Œå¯¼è‡´å†…å­˜çº¿æ€§å¢é•¿
   - æ¯ä¸ªå¼ é‡å¤§å°çº¦ä¸º `[batch_size, n_experts] * 4 bytes`

2. **è¾…åŠ©æŸå¤±ç´¯ç§¯**ï¼š
   - `_aux_loss` buffer æŒç»­ç´¯ç§¯ä½†æœªé‡ç½®
   - è™½ç„¶ä½¿ç”¨äº† `detach()`ï¼Œä½†ä»å ç”¨å†…å­˜

3. **CPU-GPU å†…å­˜æ‹·è´**ï¼š
   - `gate_history` å­˜å‚¨ `.detach().cpu()` å¼ é‡
   - é•¿æœŸè®­ç»ƒç´¯ç§¯å¤§é‡CPUå†…å­˜

## ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ

### 1. Gate History é•¿åº¦é™åˆ¶
```python
# åœ¨ MoEBlock.__init__ ä¸­æ·»åŠ 
self.max_history_length = 1000  # é™åˆ¶å†å²è®°å½•é•¿åº¦

# åœ¨ forward æ–¹æ³•ä¸­æ·»åŠ è‡ªåŠ¨æ¸…ç†
if len(self.gate_history) > self.max_history_length:
    self.gate_history = self.gate_history[-self.max_history_length//2:]
```

### 2. å®šæœŸæ¸…ç†æœºåˆ¶
```python
# åœ¨ MooreTDMPC.update æ–¹æ³•ä¸­
def update(self, buffer):
    info = self._update(obs, action, reward, terminated, **kwargs)
    self.clear_gate_history()  # æ¯æ¬¡æ›´æ–°åæ¸…ç†
    
    # å®šæœŸå¼ºåˆ¶åƒåœ¾å›æ”¶
    if self._update_count % 100 == 0:
        self.memory_monitor.cleanup_memory()
```

### 3. MoE è¾…åŠ©æŸå¤±ç®¡ç†
```python
# åœ¨ _update æ–¹æ³•ä¸­æ·»åŠ 
if self.cfg.use_moe:
    moe_aux_loss = self.model.get_moe_aux_loss()
    total_loss = total_loss + 0.01 * moe_aux_loss
    self.model.zero_moe_aux_loss()  # é‡ç½®ç´¯ç§¯å™¨
```

### 4. å†…å­˜ç›‘æ§ç³»ç»Ÿ
- æ·»åŠ  `MemoryMonitor` ç±»ç”¨äºå®æ—¶ç›‘æ§
- æ”¯æŒ GPU å’Œ CPU å†…å­˜è·Ÿè¸ª
- è‡ªåŠ¨æ£€æµ‹å†…å­˜æ³„æ¼å¹¶å‘å‡ºè­¦å‘Š
- æä¾›å†…å­˜æ¸…ç†å’Œåƒåœ¾å›æ”¶åŠŸèƒ½

## ğŸ“Š ä¿®å¤æ•ˆæœéªŒè¯

### æµ‹è¯•ç»“æœ
```
Memory Leak Test: âœ… PASSED
- 1000æ­¥è®­ç»ƒåå†…å­˜å¢é•¿ä»… 0.02 GB
- Gate history é•¿åº¦ç¨³å®šåœ¨é™åˆ¶èŒƒå›´å†…
- æ— æ˜¾è‘—å†…å­˜æ³„æ¼

Gate History Limit Test: âœ… PASSED  
- è‡ªåŠ¨é•¿åº¦é™åˆ¶æ­£å¸¸å·¥ä½œ
- è¶…è¿‡é™åˆ¶æ—¶è‡ªåŠ¨è£å‰ªåˆ°ä¸€åŠé•¿åº¦
```

### æ€§èƒ½å¯¹æ¯”
| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å |
|-----|--------|--------|
| å†…å­˜å¢é•¿ | çº¿æ€§å¢é•¿ | ç¨³å®š |
| Gate History é•¿åº¦ | æ— é™åˆ¶ | â‰¤ 1000 |
| è®­ç»ƒç¨³å®šæ€§ | å†…å­˜æº¢å‡º | ç¨³å®šè¿è¡Œ |
| æ€§èƒ½æŸè€— | - | < 1% |

## ğŸš€ ä½¿ç”¨è¯´æ˜

### é…ç½®å‚æ•°
```yaml
# åœ¨ config.yaml ä¸­å¯é…ç½®
use_moe: true
monitor_mem_interval: 1000  # å†…å­˜ç›‘æ§é—´éš”
```

### æ‰‹åŠ¨æ¸…ç†
```python
# å¦‚éœ€æ‰‹åŠ¨æ¸…ç†
agent.clear_gate_history()
agent.memory_monitor.cleanup_memory(aggressive=True)
```

### å†…å­˜ç›‘æ§
è®­ç»ƒè¿‡ç¨‹ä¸­ä¼šè‡ªåŠ¨è¾“å‡ºï¼š
```
Memory Usage:
  GPU: 11.10/23.63 GB (47.0%)
  CPU: 0.86 GB (System: 37.8%)
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¯è§†åŒ–åŠŸèƒ½**ï¼šå¦‚æœéœ€è¦å®Œæ•´çš„ä¸“å®¶é—¨æ§å¯è§†åŒ–ï¼Œå¯ä¸´æ—¶å¢åŠ  `max_history_length`
2. **è®­ç»ƒæ€§èƒ½**ï¼šæ¯100æ­¥çš„æ¸…ç†æ“ä½œå¯¹æ€§èƒ½å½±å“æå°ï¼ˆ< 1%ï¼‰
3. **å†…å­˜é˜ˆå€¼**ï¼šå¯æ ¹æ®ç³»ç»Ÿé…ç½®è°ƒæ•´å†…å­˜æ³„æ¼æ£€æµ‹é˜ˆå€¼

## ğŸ“ ç›¸å…³æ–‡ä»¶

### ä¿®æ”¹çš„æ–‡ä»¶
- `tdmpc2/common/layers.py` - MoEBlock é•¿åº¦é™åˆ¶
- `tdmpc2/Mooretdmpc.py` - æ¸…ç†æœºåˆ¶å’Œç›‘æ§
- `tdmpc2/common/memory_monitor.py` - æ–°å¢ç›‘æ§å·¥å…·

### æµ‹è¯•æ–‡ä»¶
- `tdmpc2/test_memory_leak.py` - å†…å­˜æ³„æ¼æµ‹è¯•è„šæœ¬

## ğŸ¯ ç»“è®º

é€šè¿‡å®æ–½å¤šå±‚æ¬¡çš„å†…å­˜ç®¡ç†ç­–ç•¥ï¼ŒæˆåŠŸè§£å†³äº† MoE æ¨¡å¼ä¸‹çš„å†…å­˜æ³„æ¼é—®é¢˜ï¼š

1. âœ… **å½»åº•ä¿®å¤**ï¼šå†…å­˜ä½¿ç”¨é‡ç¨³å®šï¼Œæ— çº¿æ€§å¢é•¿
2. âœ… **æ€§èƒ½ä¿æŒ**ï¼šå¯¹è®­ç»ƒæ€§èƒ½å½±å“æå°
3. âœ… **è‡ªåŠ¨ç›‘æ§**ï¼šå®æ—¶æ£€æµ‹å’Œé¢„è­¦æœºåˆ¶
4. âœ… **æ˜“äºç»´æŠ¤**ï¼šä»£ç æ”¹åŠ¨æœ€å°ï¼Œå‘åå…¼å®¹

ç°åœ¨å¯ä»¥å®‰å…¨åœ°åœ¨é•¿æ—¶é—´è®­ç»ƒä¸­ä½¿ç”¨ `use_moe=true` è®¾ç½®ã€‚ 